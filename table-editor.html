<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>table</title>
</head>

<style>
    .tables-container {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        align-content: center;
        gap: 20px;
    }

    .table-holder {
        border: 2px solid black;
        padding: 5px;
    }

    #tokenstat {
        color: red;
    }
</style>

<body>
    <button id="generateTokenLink">Clicker pour commencez</button>
    <button id="save-changes">Sauvgarder les changements</button>
    <h1 id="tokenstat">Not ready</h1>
    <h1 id="submitMessage"></h1>
    <div class="tables-container">
        <div class="table-holder table-holder-1">
            <h3>2 Baccalauréat (Groupe 1)</h3>
            <table>
                <tr>
                    <th></th>
                    <th>19:00-20:30</th>
                    <th>20:30-22:00</th>
                </tr>
                <tr>
                    <td>Lundi</td>
                    <td><input type="text" name="" id="" class="input-element"></td>
                    <td><input type="text" name="" id="" class="input-element"></td>
                </tr>
                <tr>
                    <td>Mardi</td>
                    <td><input type="text" name="" id="" class="input-element"></td>
                    <td><input type="text" name="" id="" class="input-element"></td>
                </tr>
                <tr>
                    <td>Mercredi</td>
                    <td><input type="text" name="" id="" class="input-element"></td>
                    <td><input type="text" name="" id="" class="input-element"></td>
                </tr>
                <tr>
                    <td>Jeudi</td>
                    <td><input type="text" name="" id="" class="input-element"></td>
                    <td><input type="text" name="" id="" class="input-element"></td>
                </tr>
                <tr>
                    <td>Vendredi</td>
                    <td><input type="text" name="" id="" class="input-element"></td>
                    <td><input type="text" name="" id="" class="input-element"></td>
                </tr>
                <tr>
                    <td>Samedi</td>
                    <td><input type="text" name="" id="" class="input-element"></td>
                    <td><input type="text" name="" id="" class="input-element"></td>
                </tr>
                <tr>
                    <td>Dimanche</td>
                    <td><input type="text" name="" id="" class="input-element"></td>
                    <td><input type="text" name="" id="" class="input-element"></td>
                </tr>
            </table>
        </div>
        <div class="table-holder table-holder-2">
            <h3>2 Baccalauréat (Groupe 2)</h3>
            <table>
                <tr>
                    <th></th>
                    <th>19:00-20:30</th>
                    <th>20:30-22:00</th>
                </tr>
                <tr>
                    <td>Lundi</td>
                    <td><input type="text" name="" id="" class="input-element"></td>
                    <td><input type="text" name="" id="" class="input-element"></td>
                </tr>
                <tr>
                    <td>Mardi</td>
                    <td><input type="text" name="" id="" class="input-element"></td>
                    <td><input type="text" name="" id="" class="input-element"></td>
                </tr>
                <tr>
                    <td>Mercredi</td>
                    <td><input type="text" name="" id="" class="input-element"></td>
                    <td><input type="text" name="" id="" class="input-element"></td>
                </tr>
                <tr>
                    <td>Jeudi</td>
                    <td><input type="text" name="" id="" class="input-element"></td>
                    <td><input type="text" name="" id="" class="input-element"></td>
                </tr>
                <tr>
                    <td>Vendredi</td>
                    <td><input type="text" name="" id="" class="input-element"></td>
                    <td><input type="text" name="" id="" class="input-element"></td>
                </tr>
                <tr>
                    <td>Samedi</td>
                    <td><input type="text" name="" id="" class="input-element"></td>
                    <td><input type="text" name="" id="" class="input-element"></td>
                </tr>
                <tr>
                    <td>Dimanche</td>
                    <td><input type="text" name="" id="" class="input-element"></td>
                    <td><input type="text" name="" id="" class="input-element"></td>
                </tr>
            </table>
        </div>
        <div class="table-holder table-holder-3">
            <h3>1 Baccalauréat</h3>
            <table>
                <tr>
                    <th></th>
                    <th>19:00-20:30</th>
                    <th>20:30-22:00</th>
                </tr>
                <tr>
                    <td>Lundi</td>
                    <td><input type="text" name="" id="" class="input-element"></td>
                    <td><input type="text" name="" id="" class="input-element"></td>
                </tr>
                <tr>
                    <td>Mardi</td>
                    <td><input type="text" name="" id="" class="input-element"></td>
                    <td><input type="text" name="" id="" class="input-element"></td>
                </tr>
                <tr>
                    <td>Mercredi</td>
                    <td><input type="text" name="" id="" class="input-element"></td>
                    <td><input type="text" name="" id="" class="input-element"></td>
                </tr>
                <tr>
                    <td>Jeudi</td>
                    <td><input type="text" name="" id="" class="input-element"></td>
                    <td><input type="text" name="" id="" class="input-element"></td>
                </tr>
                <tr>
                    <td>Vendredi</td>
                    <td><input type="text" name="" id="" class="input-element"></td>
                    <td><input type="text" name="" id="" class="input-element"></td>
                </tr>
                <tr>
                    <td>Samedi</td>
                    <td><input type="text" name="" id="" class="input-element"></td>
                    <td><input type="text" name="" id="" class="input-element"></td>
                </tr>
                <tr>
                    <td>Dimanche</td>
                    <td><input type="text" name="" id="" class="input-element"></td>
                    <td><input type="text" name="" id="" class="input-element"></td>
                </tr>
            </table>
        </div>
        <div class="table-holder table-holder-4">
            <h3>Tronc Commun</h3>
            <table>
                <tr>
                    <th></th>
                    <th>19:00-20:30</th>
                    <th>20:30-22:00</th>
                </tr>
                <tr>
                    <td>Lundi</td>
                    <td><input type="text" name="" id="" class="input-element"></td>
                    <td><input type="text" name="" id="" class="input-element"></td>
                </tr>
                <tr>
                    <td>Mardi</td>
                    <td><input type="text" name="" id="" class="input-element"></td>
                    <td><input type="text" name="" id="" class="input-element"></td>
                </tr>
                <tr>
                    <td>Mercredi</td>
                    <td><input type="text" name="" id="" class="input-element"></td>
                    <td><input type="text" name="" id="" class="input-element"></td>
                </tr>
                <tr>
                    <td>Jeudi</td>
                    <td><input type="text" name="" id="" class="input-element"></td>
                    <td><input type="text" name="" id="" class="input-element"></td>
                </tr>
                <tr>
                    <td>Vendredi</td>
                    <td><input type="text" name="" id="" class="input-element"></td>
                    <td><input type="text" name="" id="" class="input-element"></td>
                </tr>
                <tr>
                    <td>Samedi</td>
                    <td><input type="text" name="" id="" class="input-element"></td>
                    <td><input type="text" name="" id="" class="input-element"></td>
                </tr>
                <tr>
                    <td>Dimanche</td>
                    <td><input type="text" name="" id="" class="input-element"></td>
                    <td><input type="text" name="" id="" class="input-element"></td>
                </tr>
            </table>
        </div>
        <div class="table-holder table-holder-5">
            <h3>3 ème A.C (Groupe 1)</h3>
            <table>
                <tr>
                    <th></th>
                    <th>19:00-20:30</th>
                    <th>20:30-22:00</th>
                </tr>
                <tr>
                    <td>Lundi</td>
                    <td><input type="text" name="" id="" class="input-element"></td>
                    <td><input type="text" name="" id="" class="input-element"></td>
                </tr>
                <tr>
                    <td>Mardi</td>
                    <td><input type="text" name="" id="" class="input-element"></td>
                    <td><input type="text" name="" id="" class="input-element"></td>
                </tr>
                <tr>
                    <td>Mercredi</td>
                    <td><input type="text" name="" id="" class="input-element"></td>
                    <td><input type="text" name="" id="" class="input-element"></td>
                </tr>
                <tr>
                    <td>Jeudi</td>
                    <td><input type="text" name="" id="" class="input-element"></td>
                    <td><input type="text" name="" id="" class="input-element"></td>
                </tr>
                <tr>
                    <td>Vendredi</td>
                    <td><input type="text" name="" id="" class="input-element"></td>
                    <td><input type="text" name="" id="" class="input-element"></td>
                </tr>
                <tr>
                    <td>Samedi</td>
                    <td><input type="text" name="" id="" class="input-element"></td>
                    <td><input type="text" name="" id="" class="input-element"></td>
                </tr>
                <tr>
                    <td>Dimanche</td>
                    <td><input type="text" name="" id="" class="input-element"></td>
                    <td><input type="text" name="" id="" class="input-element"></td>
                </tr>
            </table>
        </div>
        <div class="table-holder table-holder-6">
            <h3>3 ème A.C (Groupe 2)</h3>
            <table>
                <tr>
                    <th></th>
                    <th>19:00-20:30</th>
                    <th>20:30-22:00</th>
                </tr>
                <tr>
                    <td>Lundi</td>
                    <td><input type="text" name="" id="" class="input-element"></td>
                    <td><input type="text" name="" id="" class="input-element"></td>
                </tr>
                <tr>
                    <td>Mardi</td>
                    <td><input type="text" name="" id="" class="input-element"></td>
                    <td><input type="text" name="" id="" class="input-element"></td>
                </tr>
                <tr>
                    <td>Mercredi</td>
                    <td><input type="text" name="" id="" class="input-element"></td>
                    <td><input type="text" name="" id="" class="input-element"></td>
                </tr>
                <tr>
                    <td>Jeudi</td>
                    <td><input type="text" name="" id="" class="input-element"></td>
                    <td><input type="text" name="" id="" class="input-element"></td>
                </tr>
                <tr>
                    <td>Vendredi</td>
                    <td><input type="text" name="" id="" class="input-element"></td>
                    <td><input type="text" name="" id="" class="input-element"></td>
                </tr>
                <tr>
                    <td>Samedi</td>
                    <td><input type="text" name="" id="" class="input-element"></td>
                    <td><input type="text" name="" id="" class="input-element"></td>
                </tr>
                <tr>
                    <td>Dimanche</td>
                    <td><input type="text" name="" id="" class="input-element"></td>
                    <td><input type="text" name="" id="" class="input-element"></td>
                </tr>
            </table>
        </div>
        <div class="table-holder table-holder-7">
            <h3>2 ème A.C</h3>
            <table>
                <tr>
                    <th></th>
                    <th>19:00-20:30</th>
                    <th>20:30-22:00</th>
                </tr>
                <tr>
                    <td>Lundi</td>
                    <td><input type="text" name="" id="" class="input-element"></td>
                    <td><input type="text" name="" id="" class="input-element"></td>
                </tr>
                <tr>
                    <td>Mardi</td>
                    <td><input type="text" name="" id="" class="input-element"></td>
                    <td><input type="text" name="" id="" class="input-element"></td>
                </tr>
                <tr>
                    <td>Mercredi</td>
                    <td><input type="text" name="" id="" class="input-element"></td>
                    <td><input type="text" name="" id="" class="input-element"></td>
                </tr>
                <tr>
                    <td>Jeudi</td>
                    <td><input type="text" name="" id="" class="input-element"></td>
                    <td><input type="text" name="" id="" class="input-element"></td>
                </tr>
                <tr>
                    <td>Vendredi</td>
                    <td><input type="text" name="" id="" class="input-element"></td>
                    <td><input type="text" name="" id="" class="input-element"></td>
                </tr>
                <tr>
                    <td>Samedi</td>
                    <td><input type="text" name="" id="" class="input-element"></td>
                    <td><input type="text" name="" id="" class="input-element"></td>
                </tr>
                <tr>
                    <td>Dimanche</td>
                    <td><input type="text" name="" id="" class="input-element"></td>
                    <td><input type="text" name="" id="" class="input-element"></td>
                </tr>
            </table>
        </div>
        <div class="table-holder table-holder-8">
            <h3>1 er A.C</h3>
            <table>
                <tr>
                    <th></th>
                    <th>19:00-20:30</th>
                    <th>20:30-22:00</th>
                </tr>
                <tr>
                    <td>Lundi</td>
                    <td><input type="text" name="" id="" class="input-element"></td>
                    <td><input type="text" name="" id="" class="input-element"></td>
                </tr>
                <tr>
                    <td>Mardi</td>
                    <td><input type="text" name="" id="" class="input-element"></td>
                    <td><input type="text" name="" id="" class="input-element"></td>
                </tr>
                <tr>
                    <td>Mercredi</td>
                    <td><input type="text" name="" id="" class="input-element"></td>
                    <td><input type="text" name="" id="" class="input-element"></td>
                </tr>
                <tr>
                    <td>Jeudi</td>
                    <td><input type="text" name="" id="" class="input-element"></td>
                    <td><input type="text" name="" id="" class="input-element"></td>
                </tr>
                <tr>
                    <td>Vendredi</td>
                    <td><input type="text" name="" id="" class="input-element"></td>
                    <td><input type="text" name="" id="" class="input-element"></td>
                </tr>
                <tr>
                    <td>Samedi</td>
                    <td><input type="text" name="" id="" class="input-element"></td>
                    <td><input type="text" name="" id="" class="input-element"></td>
                </tr>
                <tr>
                    <td>Dimanche</td>
                    <td><input type="text" name="" id="" class="input-element"></td>
                    <td><input type="text" name="" id="" class="input-element"></td>
                </tr>
            </table>
        </div>
    </div>
</body>

<script>
    let accessToken;

    function isDropboxTokenValid() {
        const expirationTime = localStorage.getItem("dropbox_token_expiry");
        if (!expirationTime) return false;

        return Date.now() < parseInt(expirationTime, 10);
    }

    function getStoredDropboxToken() {
        if (isDropboxTokenValid()) {
            return localStorage.getItem("dropbox_token");
        } else {
            console.log("Dropbox token expired. Attempting to get a new one...");
            openDropboxLogin();
            return null;
        }
    }

    function checkDropboxToken() {
        const token = getStoredDropboxToken();

        if (token) {
            accessToken = token;
            document.getElementById('tokenstat').innerHTML = "Ready";
            document.getElementById('tokenstat').style.color = "green";
            console.log("Using stored Dropbox token:", token);

            scheduleTokenRefresh();
        } else {
            openDropboxLogin();
            console.log("No valid token found. Redirecting to login...");
        }
    }

    function openDropboxLogin() {
        const CLIENT_ID = "kigjitoui3np9di";
        const REDIRECT_URI = "https://centre-lexellence.github.io/table/callback.html";

        const authUrl = `https://www.dropbox.com/oauth2/authorize?response_type=token&client_id=${CLIENT_ID}&redirect_uri=${encodeURIComponent(REDIRECT_URI)}`;

        const newTab = window.open(authUrl, "_blank");

        const checkInterval = setInterval(() => {
            if (newTab.closed) {
                clearInterval(checkInterval);
                console.log("Popup closed");
                checkDropboxToken();
            }
        }, 1000);
    }

    function scheduleTokenRefresh() {
        const expirationTime = parseInt(localStorage.getItem("dropbox_token_expiry"), 10);
        const timeLeft = expirationTime - Date.now();

        if (timeLeft > 0) {
            console.log(`Token will refresh in ${Math.floor(timeLeft / 60000)} minutes.`);
            setTimeout(() => {
                console.log("Refreshing Dropbox token...");
                openDropboxLogin();
            }, timeLeft - 60000);
        }
    }

    window.onload = checkDropboxToken;

    console.log(accessToken);

    let tableArray = [];

    let objectTable;

    const sharedLinkFetch = "https://www.dropbox.com/scl/fi/1e2ytav07ml1riekgs71d/table.json?rlkey=thelsora1zrtsah5qzjyz9fch&st=yhp1wcxc&dl=0";

    const directLink = sharedLinkFetch.replace("www.dropbox.com", "dl.dropboxusercontent.com");

    fetch(directLink)
        .then(table => table.json())
        .then((table) => {
            for (let i = 0; i < table.table.length; i++) {
                for (element of table.table[i].content) {
                    tableArray.push(element[0], element[1])
                }
            }
            console.log(tableArray)

            objectTable = { ...table };

            let number = 0

            document.querySelectorAll('.input-element').forEach((element) => {

                element.value = tableArray[number];

                number++;
                /*
                element.addEventListener('input', (event) => {
                    console.log(`Value changed to: ${event.target.value}`);
                });
                */
            });
        });


    document.getElementById('save-changes').addEventListener('click', () => {

        sharedLink = "https://www.dropbox.com/scl/fi/1e2ytav07ml1riekgs71d/table.json?rlkey=thelsora1zrtsah5qzjyz9fch&st=yhp1wcxc&dl=0";

        const directLink = sharedLink.replace("www.dropbox.com", "dl.dropboxusercontent.com");

        const apiBaseUrl = 'https://content.dropboxapi.com/2/files';

        const filePath = "/table.json";

        fetch(`${apiBaseUrl}/download`, {
            method: 'POST',
            headers: {
                Authorization: `Bearer ${accessToken}`,
                'Dropbox-API-Arg': JSON.stringify({
                    path: filePath,
                }),
            },
        })
            .then((response) => response.text())
            .then((data) => {
                tableArrayNew = []

                document.querySelectorAll('.input-element').forEach((element) => {

                    tableArrayNew.push(element.value);
                });

                let output = {
                    "table": [
                        {
                            "name": "2 Baccalauréat (Groupe 1)",
                            "content": [
                                [
                                    "69",
                                    "ahah"
                                ],
                                [
                                    "",
                                    ""
                                ],
                                [
                                    "apah",
                                    "nuuh"
                                ],
                                [
                                    "",
                                    ""
                                ],
                                [
                                    "",
                                    ""
                                ],
                                [
                                    "",
                                    ""
                                ]
                            ]
                        },
                        {
                            "name": "2 Baccalauréat (Groupe 2)",
                            "content": [
                                [
                                    "",
                                    ""
                                ],
                                [
                                    "",
                                    ""
                                ],
                                [
                                    "",
                                    ""
                                ],
                                [
                                    "",
                                    ""
                                ],
                                [
                                    "",
                                    ""
                                ],
                                [
                                    "",
                                    ""
                                ]
                            ]
                        },
                        {
                            "name": "1 Baccalauréat",
                            "content": [
                                [
                                    "",
                                    ""
                                ],
                                [
                                    "",
                                    ""
                                ],
                                [
                                    "",
                                    ""
                                ],
                                [
                                    "",
                                    ""
                                ],
                                [
                                    "",
                                    ""
                                ],
                                [
                                    "",
                                    ""
                                ]
                            ]
                        },
                        {
                            "name": "Tronc Commun",
                            "content": [
                                [
                                    "",
                                    ""
                                ],
                                [
                                    "",
                                    ""
                                ],
                                [
                                    "",
                                    ""
                                ],
                                [
                                    "",
                                    ""
                                ],
                                [
                                    "",
                                    ""
                                ],
                                [
                                    "",
                                    ""
                                ]
                            ]
                        },
                        {
                            "name": "3 ème A.C (Groupe 2)",
                            "content": [
                                [
                                    "",
                                    ""
                                ],
                                [
                                    "",
                                    ""
                                ],
                                [
                                    "",
                                    ""
                                ],
                                [
                                    "",
                                    ""
                                ],
                                [
                                    "",
                                    ""
                                ],
                                [
                                    "",
                                    ""
                                ]
                            ]
                        },
                        {
                            "name": "3 ème A.C (Groupe 1)",
                            "content": [
                                [
                                    "",
                                    ""
                                ],
                                [
                                    "",
                                    ""
                                ],
                                [
                                    "",
                                    ""
                                ],
                                [
                                    "",
                                    ""
                                ],
                                [
                                    "",
                                    ""
                                ],
                                [
                                    "",
                                    ""
                                ]
                            ]
                        },
                        {
                            "name": "2 ème A.C",
                            "content": [
                                [
                                    "",
                                    ""
                                ],
                                [
                                    "",
                                    ""
                                ],
                                [
                                    "",
                                    ""
                                ],
                                [
                                    "",
                                    ""
                                ],
                                [
                                    "",
                                    ""
                                ],
                                [
                                    "",
                                    ""
                                ]
                            ]
                        },
                        {
                            "name": "1 er A.C",
                            "content": [
                                [
                                    "",
                                    ""
                                ],
                                [
                                    "",
                                    ""
                                ],
                                [
                                    "",
                                    ""
                                ],
                                [
                                    "",
                                    ""
                                ],
                                [
                                    "",
                                    ""
                                ],
                                [
                                    "",
                                    ""
                                ]
                            ]
                        }
                    ]
                };

                let numbering = 0

                for (let i = 0; i < objectTable.table.length; i++) {
                    for (let j = 0; j < objectTable.table[i].content.length; j++) {
                        output.table[i].content[j] = [tableArrayNew[numbering], tableArrayNew[numbering + 1]]
                        numbering += 2;
                    }
                }

                console.log(tableArrayNew)
                console.log(output)

                console.log('Request:', {
                    method: 'POST',
                    headers: {
                        Authorization: `Bearer ${accessToken}`,
                        'Content-Type': 'application/octet-stream',
                        'Dropbox-API-Arg': JSON.stringify({
                            path: filePath,
                            mode: 'overwrite',
                        }),
                    },
                    body: output,
                });

                fetch(`${apiBaseUrl}/upload`, {
                    method: 'POST',
                    headers: {
                        Authorization: `Bearer ${accessToken}`,
                        'Content-Type': 'application/octet-stream',
                        'Dropbox-API-Arg': JSON.stringify({
                            path: filePath,
                            mode: { '.tag': 'overwrite' },
                        }),
                    },
                    body: JSON.stringify(output),
                })
                    .then(() => {
                        console.log('Object appended and saved.');
                        document.getElementById("submitMessage").innerHTML = "table changed successfully!!";
                    })
                    .catch((error) => {
                        console.error('Error saving JSON: ', error);
                    });

            })
            .catch((error) => {
                console.error('Error reading JSON file: ', error);
            });
    });

</script>

</html>