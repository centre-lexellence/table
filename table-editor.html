<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>table</title>
</head>

<style>
    .tables-container {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        align-content: center;
        gap: 20px;
    }

    .table-holder {
        border: 2px solid black;
        padding: 5px;
    }

    #tokenstat {
        color: red;
    }
</style>

<body>
    <button id="generateTokenLink">Clicker pour commencez</button>
    <button id="save-changes">Sauvgarder les changements</button>
    <h1 id="tokenstat">Not ready</h1>
    <div class="tables-container">
        <div class="table-holder table-holder-1">
            <h3>2 Baccalauréat (Groupe 1)</h3>
            <table>
                <tr>
                    <th></th>
                    <th>19:00-20:30</th>
                    <th>20:30-22:00</th>
                </tr>
                <tr>
                    <td>Lundi</td>
                    <td><input type="text" name="" id="" class="input-element"></td>
                    <td><input type="text" name="" id="" class="input-element"></td>
                </tr>
                <tr>
                    <td>Mardi</td>
                    <td><input type="text" name="" id="" class="input-element"></td>
                    <td><input type="text" name="" id="" class="input-element"></td>
                </tr>
                <tr>
                    <td>Mercredi</td>
                    <td><input type="text" name="" id="" class="input-element"></td>
                    <td><input type="text" name="" id="" class="input-element"></td>
                </tr>
                <tr>
                    <td>Jeudi</td>
                    <td><input type="text" name="" id="" class="input-element"></td>
                    <td><input type="text" name="" id="" class="input-element"></td>
                </tr>
                <tr>
                    <td>Vendredi</td>
                    <td><input type="text" name="" id="" class="input-element"></td>
                    <td><input type="text" name="" id="" class="input-element"></td>
                </tr>
                <tr>
                    <td>Samedi</td>
                    <td><input type="text" name="" id="" class="input-element"></td>
                    <td><input type="text" name="" id="" class="input-element"></td>
                </tr>
            </table>
        </div>
        <div class="table-holder table-holder-2">
            <h3>2 Baccalauréat (Groupe 2)</h3>
            <table>
                <tr>
                    <th></th>
                    <th>19:00-20:30</th>
                    <th>20:30-22:00</th>
                </tr>
                <tr>
                    <td>Lundi</td>
                    <td><input type="text" name="" id="" class="input-element"></td>
                    <td><input type="text" name="" id="" class="input-element"></td>
                </tr>
                <tr>
                    <td>Mardi</td>
                    <td><input type="text" name="" id="" class="input-element"></td>
                    <td><input type="text" name="" id="" class="input-element"></td>
                </tr>
                <tr>
                    <td>Mercredi</td>
                    <td><input type="text" name="" id="" class="input-element"></td>
                    <td><input type="text" name="" id="" class="input-element"></td>
                </tr>
                <tr>
                    <td>Jeudi</td>
                    <td><input type="text" name="" id="" class="input-element"></td>
                    <td><input type="text" name="" id="" class="input-element"></td>
                </tr>
                <tr>
                    <td>Vendredi</td>
                    <td><input type="text" name="" id="" class="input-element"></td>
                    <td><input type="text" name="" id="" class="input-element"></td>
                </tr>
                <tr>
                    <td>Samedi</td>
                    <td><input type="text" name="" id="" class="input-element"></td>
                    <td><input type="text" name="" id="" class="input-element"></td>
                </tr>
            </table>
        </div>
        <div class="table-holder table-holder-3">
            <h3>1 Baccalauréat</h3>
            <table>
                <tr>
                    <th></th>
                    <th>19:00-20:30</th>
                    <th>20:30-22:00</th>
                </tr>
                <tr>
                    <td>Lundi</td>
                    <td><input type="text" name="" id="" class="input-element"></td>
                    <td><input type="text" name="" id="" class="input-element"></td>
                </tr>
                <tr>
                    <td>Mardi</td>
                    <td><input type="text" name="" id="" class="input-element"></td>
                    <td><input type="text" name="" id="" class="input-element"></td>
                </tr>
                <tr>
                    <td>Mercredi</td>
                    <td><input type="text" name="" id="" class="input-element"></td>
                    <td><input type="text" name="" id="" class="input-element"></td>
                </tr>
                <tr>
                    <td>Jeudi</td>
                    <td><input type="text" name="" id="" class="input-element"></td>
                    <td><input type="text" name="" id="" class="input-element"></td>
                </tr>
                <tr>
                    <td>Vendredi</td>
                    <td><input type="text" name="" id="" class="input-element"></td>
                    <td><input type="text" name="" id="" class="input-element"></td>
                </tr>
                <tr>
                    <td>Samedi</td>
                    <td><input type="text" name="" id="" class="input-element"></td>
                    <td><input type="text" name="" id="" class="input-element"></td>
                </tr>
            </table>
        </div>
        <div class="table-holder table-holder-4">
            <h3>Tronc Commun</h3>
            <table>
                <tr>
                    <th></th>
                    <th>19:00-20:30</th>
                    <th>20:30-22:00</th>
                </tr>
                <tr>
                    <td>Lundi</td>
                    <td><input type="text" name="" id="" class="input-element"></td>
                    <td><input type="text" name="" id="" class="input-element"></td>
                </tr>
                <tr>
                    <td>Mardi</td>
                    <td><input type="text" name="" id="" class="input-element"></td>
                    <td><input type="text" name="" id="" class="input-element"></td>
                </tr>
                <tr>
                    <td>Mercredi</td>
                    <td><input type="text" name="" id="" class="input-element"></td>
                    <td><input type="text" name="" id="" class="input-element"></td>
                </tr>
                <tr>
                    <td>Jeudi</td>
                    <td><input type="text" name="" id="" class="input-element"></td>
                    <td><input type="text" name="" id="" class="input-element"></td>
                </tr>
                <tr>
                    <td>Vendredi</td>
                    <td><input type="text" name="" id="" class="input-element"></td>
                    <td><input type="text" name="" id="" class="input-element"></td>
                </tr>
                <tr>
                    <td>Samedi</td>
                    <td><input type="text" name="" id="" class="input-element"></td>
                    <td><input type="text" name="" id="" class="input-element"></td>
                </tr>
            </table>
        </div>
        <div class="table-holder table-holder-5">
            <h3>3 ème A.C (Groupe 1)</h3>
            <table>
                <tr>
                    <th></th>
                    <th>19:00-20:30</th>
                    <th>20:30-22:00</th>
                </tr>
                <tr>
                    <td>Lundi</td>
                    <td><input type="text" name="" id="" class="input-element"></td>
                    <td><input type="text" name="" id="" class="input-element"></td>
                </tr>
                <tr>
                    <td>Mardi</td>
                    <td><input type="text" name="" id="" class="input-element"></td>
                    <td><input type="text" name="" id="" class="input-element"></td>
                </tr>
                <tr>
                    <td>Mercredi</td>
                    <td><input type="text" name="" id="" class="input-element"></td>
                    <td><input type="text" name="" id="" class="input-element"></td>
                </tr>
                <tr>
                    <td>Jeudi</td>
                    <td><input type="text" name="" id="" class="input-element"></td>
                    <td><input type="text" name="" id="" class="input-element"></td>
                </tr>
                <tr>
                    <td>Vendredi</td>
                    <td><input type="text" name="" id="" class="input-element"></td>
                    <td><input type="text" name="" id="" class="input-element"></td>
                </tr>
                <tr>
                    <td>Samedi</td>
                    <td><input type="text" name="" id="" class="input-element"></td>
                    <td><input type="text" name="" id="" class="input-element"></td>
                </tr>
            </table>
        </div>
        <div class="table-holder table-holder-6">
            <h3>3 ème A.C (Groupe 2)</h3>
            <table>
                <tr>
                    <th></th>
                    <th>19:00-20:30</th>
                    <th>20:30-22:00</th>
                </tr>
                <tr>
                    <td>Lundi</td>
                    <td><input type="text" name="" id="" class="input-element"></td>
                    <td><input type="text" name="" id="" class="input-element"></td>
                </tr>
                <tr>
                    <td>Mardi</td>
                    <td><input type="text" name="" id="" class="input-element"></td>
                    <td><input type="text" name="" id="" class="input-element"></td>
                </tr>
                <tr>
                    <td>Mercredi</td>
                    <td><input type="text" name="" id="" class="input-element"></td>
                    <td><input type="text" name="" id="" class="input-element"></td>
                </tr>
                <tr>
                    <td>Jeudi</td>
                    <td><input type="text" name="" id="" class="input-element"></td>
                    <td><input type="text" name="" id="" class="input-element"></td>
                </tr>
                <tr>
                    <td>Vendredi</td>
                    <td><input type="text" name="" id="" class="input-element"></td>
                    <td><input type="text" name="" id="" class="input-element"></td>
                </tr>
                <tr>
                    <td>Samedi</td>
                    <td><input type="text" name="" id="" class="input-element"></td>
                    <td><input type="text" name="" id="" class="input-element"></td>
                </tr>
            </table>
        </div>
        <div class="table-holder table-holder-7">
            <h3>2 ème A.C</h3>
            <table>
                <tr>
                    <th></th>
                    <th>19:00-20:30</th>
                    <th>20:30-22:00</th>
                </tr>
                <tr>
                    <td>Lundi</td>
                    <td><input type="text" name="" id="" class="input-element"></td>
                    <td><input type="text" name="" id="" class="input-element"></td>
                </tr>
                <tr>
                    <td>Mardi</td>
                    <td><input type="text" name="" id="" class="input-element"></td>
                    <td><input type="text" name="" id="" class="input-element"></td>
                </tr>
                <tr>
                    <td>Mercredi</td>
                    <td><input type="text" name="" id="" class="input-element"></td>
                    <td><input type="text" name="" id="" class="input-element"></td>
                </tr>
                <tr>
                    <td>Jeudi</td>
                    <td><input type="text" name="" id="" class="input-element"></td>
                    <td><input type="text" name="" id="" class="input-element"></td>
                </tr>
                <tr>
                    <td>Vendredi</td>
                    <td><input type="text" name="" id="" class="input-element"></td>
                    <td><input type="text" name="" id="" class="input-element"></td>
                </tr>
                <tr>
                    <td>Samedi</td>
                    <td><input type="text" name="" id="" class="input-element"></td>
                    <td><input type="text" name="" id="" class="input-element"></td>
                </tr>
            </table>
        </div>
        <div class="table-holder table-holder-8">
            <h3>1 er A.C</h3>
            <table>
                <tr>
                    <th></th>
                    <th>19:00-20:30</th>
                    <th>20:30-22:00</th>
                </tr>
                <tr>
                    <td>Lundi</td>
                    <td><input type="text" name="" id="" class="input-element"></td>
                    <td><input type="text" name="" id="" class="input-element"></td>
                </tr>
                <tr>
                    <td>Mardi</td>
                    <td><input type="text" name="" id="" class="input-element"></td>
                    <td><input type="text" name="" id="" class="input-element"></td>
                </tr>
                <tr>
                    <td>Mercredi</td>
                    <td><input type="text" name="" id="" class="input-element"></td>
                    <td><input type="text" name="" id="" class="input-element"></td>
                </tr>
                <tr>
                    <td>Jeudi</td>
                    <td><input type="text" name="" id="" class="input-element"></td>
                    <td><input type="text" name="" id="" class="input-element"></td>
                </tr>
                <tr>
                    <td>Vendredi</td>
                    <td><input type="text" name="" id="" class="input-element"></td>
                    <td><input type="text" name="" id="" class="input-element"></td>
                </tr>
                <tr>
                    <td>Samedi</td>
                    <td><input type="text" name="" id="" class="input-element"></td>
                    <td><input type="text" name="" id="" class="input-element"></td>
                </tr>
            </table>
        </div>
    </div>
</body>

<script>
    function closeTab() {
        const currentURL = window.location.href;

        console.log(currentURL);

        if (currentURL != "https://centre-lexellence.github.io/table/table-editor.html") {
            //window.close();
        }
    }

    window.addEventListener('load', closeTab);

    const clientId = 'kigjitoui3np9di';
    const redirectUri = 'https://centre-lexellence.github.io/table/table-editor.html';
    let newWindow;
    let accessToken;

    let sharedLink;

    document.getElementById('generateTokenLink').addEventListener('click', () => {
        const authUrl = `https://www.dropbox.com/oauth2/authorize?client_id=${clientId}&response_type=token&redirect_uri=${redirectUri}`;
        newWindow = window.open(authUrl, '_blank');
        if (!newWindow) {
            alert('Please allow pop-ups to proceed.');
        }
    });

    let callCount = 0;
    const maxCallCount = 10;
    let animationFrameId;

    function captureURL() {
        if (newWindow) {
            const newWindowURL = newWindow.location.href;
            console.log('URL of the new window:', newWindowURL);

            callCount++;

            if (callCount >= maxCallCount) {
                const url = new URL(newWindowURL);
                console.log(url);
                const hash = url.hash;
                accessToken = hash.split('=')[1].split('&')[0];
                console.log(accessToken);

                newWindow.close();

                cancelAnimationFrame(animationFrameId);

                document.getElementById("tokenstat").innerHTML = "All good, now edit!";
                document.getElementById("tokenstat").style.color = "green";

            } else {
                animationFrameId = requestAnimationFrame(captureURL);
            }
        }
    };

    document.getElementById('generateTokenLink').addEventListener('click', () => {
        animationFrameId = requestAnimationFrame(captureURL);
    });

    console.log(accessToken);

    let tableArray = [];

    let objectTable;

    const sharedLinkFetch = "https://www.dropbox.com/scl/fi/8pkn7lcizifsho7ae46s0/table.json?rlkey=81zig505ueylu1uygdqvnbsak&st=49sjzk2a&dl=0";

    const directLink = sharedLinkFetch.replace("www.dropbox.com", "dl.dropboxusercontent.com");

    fetch(directLink)
        .then(table => table.json())
        .then((table) => {
            for (let i = 0; i < table.table.length; i++) {
                for (element of table.table[i].content) {
                    tableArray.push(element[0], element[1])
                }
            }
            console.log(tableArray)

            objectTable = { ...table };

            let number = 0

            document.querySelectorAll('.input-element').forEach((element) => {
                console.log(element);

                element.value = tableArray[number];

                number++;
                /*
                element.addEventListener('input', (event) => {
                    console.log(`Value changed to: ${event.target.value}`);
                });
                */
            });
        });


    document.getElementById('save-changes').addEventListener('click', () => {

        sharedLink = "https://www.dropbox.com/scl/fi/8pkn7lcizifsho7ae46s0/table.json?rlkey=81zig505ueylu1uygdqvnbsak&st=49sjzk2a&dl=0";

        const directLink = sharedLink.replace("www.dropbox.com", "dl.dropboxusercontent.com");

        const apiBaseUrl = 'https://content.dropboxapi.com/2/files';

        const filePath = "/table.json";

        fetch(`${apiBaseUrl}/download`, {
            method: 'POST',
            headers: {
                Authorization: `Bearer ${accessToken}`,
                'Dropbox-API-Arg': JSON.stringify({
                    path: filePath,
                }),
            },
        })
            .then((response) => response.text())
            .then((data) => {
                tableArrayNew = []

                document.querySelectorAll('.input-element').forEach((element) => {
                    console.log(element);

                    tableArrayNew.push(element.value);
                    /*
                    element.addEventListener('input', (event) => {
                        console.log(`Value changed to: ${event.target.value}`);
                    });
                    */
                });

                let output = {
                    "table": [
                        {
                            "name": "2 Baccalauréat (Groupe 1)",
                            "content": [
                                [
                                    "69",
                                    "ahah"
                                ],
                                [
                                    "",
                                    ""
                                ],
                                [
                                    "apah",
                                    "nuuh"
                                ],
                                [
                                    "",
                                    ""
                                ],
                                [
                                    "",
                                    ""
                                ],
                                [
                                    "",
                                    ""
                                ]
                            ]
                        },
                        {
                            "name": "2 Baccalauréat (Groupe 2)",
                            "content": [
                                [
                                    "",
                                    ""
                                ],
                                [
                                    "",
                                    ""
                                ],
                                [
                                    "",
                                    ""
                                ],
                                [
                                    "",
                                    ""
                                ],
                                [
                                    "",
                                    ""
                                ],
                                [
                                    "",
                                    ""
                                ]
                            ]
                        },
                        {
                            "name": "1 Baccalauréat",
                            "content": [
                                [
                                    "",
                                    ""
                                ],
                                [
                                    "",
                                    ""
                                ],
                                [
                                    "",
                                    ""
                                ],
                                [
                                    "",
                                    ""
                                ],
                                [
                                    "",
                                    ""
                                ],
                                [
                                    "",
                                    ""
                                ]
                            ]
                        },
                        {
                            "name": "Tronc Commun",
                            "content": [
                                [
                                    "",
                                    ""
                                ],
                                [
                                    "",
                                    ""
                                ],
                                [
                                    "",
                                    ""
                                ],
                                [
                                    "",
                                    ""
                                ],
                                [
                                    "",
                                    ""
                                ],
                                [
                                    "",
                                    ""
                                ]
                            ]
                        },
                        {
                            "name": "3 ème A.C (Groupe 2)",
                            "content": [
                                [
                                    "",
                                    ""
                                ],
                                [
                                    "",
                                    ""
                                ],
                                [
                                    "",
                                    ""
                                ],
                                [
                                    "",
                                    ""
                                ],
                                [
                                    "",
                                    ""
                                ],
                                [
                                    "",
                                    ""
                                ]
                            ]
                        },
                        {
                            "name": "3 ème A.C (Groupe 1)",
                            "content": [
                                [
                                    "",
                                    ""
                                ],
                                [
                                    "",
                                    ""
                                ],
                                [
                                    "",
                                    ""
                                ],
                                [
                                    "",
                                    ""
                                ],
                                [
                                    "",
                                    ""
                                ],
                                [
                                    "",
                                    ""
                                ]
                            ]
                        },
                        {
                            "name": "2 ème A.C",
                            "content": [
                                [
                                    "",
                                    ""
                                ],
                                [
                                    "",
                                    ""
                                ],
                                [
                                    "",
                                    ""
                                ],
                                [
                                    "",
                                    ""
                                ],
                                [
                                    "",
                                    ""
                                ],
                                [
                                    "",
                                    ""
                                ]
                            ]
                        },
                        {
                            "name": "1 er A.C",
                            "content": [
                                [
                                    "",
                                    ""
                                ],
                                [
                                    "",
                                    ""
                                ],
                                [
                                    "",
                                    ""
                                ],
                                [
                                    "",
                                    ""
                                ],
                                [
                                    "",
                                    ""
                                ],
                                [
                                    "",
                                    ""
                                ]
                            ]
                        }
                    ]
                };

                let numbering = 0

                for (let i = 0; i < objectTable.table.length; i++) {
                    for (let j = 0; j < objectTable.table[i].content.length; j++) {
                        output.table[i][j] = [tableArrayNew[numbering], tableArrayNew[numbering + 1]]
                        numbering += 2;
                    }
                }

                console.log(tableArrayNew)
                console.log(output)

                fetch(`${apiBaseUrl}/upload`, {
                    method: 'POST',
                    headers: {
                        Authorization: `Bearer ${accessToken}`,
                        'Content-Type': 'application/octet-stream',
                        'Dropbox-API-Arg': JSON.stringify({
                            path: filePath,
                            mode: { '.tag': 'overwrite' },
                        }),
                    },
                    body: JSON.stringify(output),
                })
                    .then(() => {
                        console.log('Object appended and saved.');
                        document.getElementById("submitMessage").innerHTML = "News added successfully!!";
                    })
                    .catch((error) => {
                        console.error('Error saving JSON: ', error);
                    });

            })
            .catch((error) => {
                console.error('Error reading JSON file: ', error);
            });
    });

</script>

</html>